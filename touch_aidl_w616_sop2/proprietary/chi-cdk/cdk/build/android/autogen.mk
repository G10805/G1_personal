ifeq ($(CAMX_CHICDK_PATH),)
  LOCAL_PATH            := $(abspath $(call my-dir)/../..)
  CAMX_CHICDK_PATH      := $(abspath $(LOCAL_PATH)/../..)
else
  LOCAL_PATH := $(CAMX_CHICDK_PATH)/vendor/chioverride/default
endif

CAMX_CURDIR             := $(call my-dir)

include $(CLEAR_VARS)

ifeq ($(CAMX_PYTHON),)
ifeq ($(PLATFORM_VERSION),$(filter T Tiramisu 13 U UpsideDownCake 14 V VanillaIceCream 15, $(PLATFORM_VERSION)))
CAMX_PYTHON         := $(abspath prebuilts/build-tools/path/linux-x86/python2)
else
CAMX_PYTHON         := $(abspath prebuilts/python/linux-x86/2.7.5/bin/python)
endif
endif

CAMX_PRODUCT := $(TARGET_BOARD_PLATFORM)
ifneq ( ,$(filter msmnile msmnile_au msmnile_au_km4 msmnile_au_ar msmnile_tb sdmshrike_au, $(TARGET_BOARD_PLATFORM)))
CAMX_PRODUCT := msmnile
endif

# Run UsecaseComposer to generate g_<target>_usecase.xml
COMPOSER_CMD := $(CAMX_PYTHON) $(CAMX_CDK_PATH)/topology/usecasecomposer.py -i $(CAMX_VENDOR_PATH)/topology/qcom/$(CAMX_PRODUCT)/$(CAMX_PRODUCT)_usecase.xml -o $(CAMX_VENDOR_PATH)/topology/qcom/$(CAMX_PRODUCT)/g_$(CAMX_PRODUCT)_usecase.xml -d $(CAMX_VENDOR_PATH)/topology/qcom/usecase-components -t $(CAMX_PRODUCT) -H $(CAMX_CDK_PATH)/topology/xmlheader.txt

COMPOSER_STATUS := $(shell $(COMPOSER_CMD)|| echo [UsecaseComposerFailure])

CONVERTER_CMD := perl $(CAMX_CDK_PATH)/topology/usecaseconverter.pl $(CAMX_VENDOR_PATH)/topology/qcom/common/common_usecase.xml $(CAMX_VENDOR_PATH)/topology/qcom/$(CAMX_PRODUCT)/g_$(CAMX_PRODUCT)_usecase.xml $(LOCAL_PATH)/$(CAMX_PRODUCT)/g_pipelines.h

CONVERTER_STATUS := $(shell $(CONVERTER_CMD) || echo [UsecaseConverterFailure])

include $(CLEAR_VARS)

# Binary name
LOCAL_MODULE := libcamxgenerated
LOCAL_MODULE_CLASS := STATIC_LIBRARIES

# Get definitions common to the CAMX project here
include $(CAMX_CHICDK_PATH)/vendor/common.mk

# The following command call the buildbins.py to to generate makefiles and code.
# This task should be done before compiling the source code.

CAMX_BUILDBINS_SCRIPT := $(CAMX_CDK_PATH)/tools/buildbins.py

ifeq ($(CAMX_EXT_VBUILD),)
CAMX_GEN_DIR := $(call local-generated-sources-dir)/generated
else
CAMX_GEN_DIR := $(CAMX_CDK_PATH)/generated
endif

CAMX_GEN_MK_DIR := $(CAMX_GEN_DIR)
$(info Generating camx supplementary makefiles.)
CAMX_SUCCESS_PHRASE   := ZFCJDBJGVW
CAMX_GEN_MAKEFILE     := $(CAMX_PYTHON) $(CAMX_BUILDBINS_SCRIPT) \
                         --target=code \
                         --gen-code-dir=$(CAMX_GEN_DIR)
CAMX_BUILD_OUTPUT     := $(shell $(CAMX_GEN_MAKEFILE) && echo $(CAMX_SUCCESS_PHRASE))

# Show the output to the screen
CAMX_BUILD_OUTPUT_1   := $(subst $(CAMX_SUCCESS_PHRASE),,$(CAMX_BUILD_OUTPUT))
$(info $(CAMX_BUILD_OUTPUT_1))

# Something is wrong if the last word in the outputs is not the CAMX_SUCCESS_PHRASE.
ifneq ($(CAMX_SUCCESS_PHRASE),$(lastword $(CAMX_BUILD_OUTPUT)))
  $(error Cannot generate supplementary makefiles)
endif
# End of buildbins.py call

# Include makefiles which are generated by the parser
include $(CAMX_GEN_MK_DIR)/g_fd.mk
include $(CAMX_GEN_MK_DIR)/g_sensor.mk
include $(CAMX_GEN_MK_DIR)/g_chromatix.mk
include $(CAMX_GEN_MK_DIR)/g_parser.mk

CAMX_GEN_INC_FILES :=                           \
    $(CAMX_FACEDETECTION_INC_FILES)             \
    $(CAMX_PARSER_INC_FILES)                    \
    $(CAMX_SENSOR_INC_FILES)                    \
    $(CAMX_CHROMATIX_INC_FILES)

CAMX_GEN_SRC_FILES :=                           \
    $(CAMX_FACEDETECTION_SRC_FILES)             \
    $(CAMX_PARSER_SRC_FILES)                    \
    $(CAMX_SENSOR_SRC_FILES)                    \
    $(CAMX_CHROMATIX_SRC_FILES)

# Put here any libraries that should be linked by CAMX projects
LOCAL_C_LIBS := $(CAMX_C_LIBS)

# Paths to included headers
LOCAL_C_INCLUDES :=                             \
    $(CAMX_C_INCLUDES)                          \
    $(CAMX_GEN_DIR)/g_parser                    \
    $(CAMX_GEN_DIR)/g_facedetection             \
    $(CAMX_GEN_DIR)/g_sensor                    \
    $(CAMX_GEN_DIR)/g_chromatix

LOCAL_EXPORT_C_INCLUDE_DIRS :=                  \
    $(CAMX_GEN_DIR)/g_parser                    \
    $(CAMX_GEN_DIR)/g_facedetection             \
    $(CAMX_GEN_DIR)/g_sensor                    \
    $(CAMX_GEN_DIR)/g_chromatix

# Compiler flags
LOCAL_CFLAGS := $(CAMX_CFLAGS)                  \
    -Wno-uninitialized                          \
    -Wno-unused-parameter                       \
    -Wno-unused-variable

LOCAL_CPPFLAGS := $(CAMX_CPPFLAGS)

LOCAL_LDFLAGS :=
LOCAL_LDLIBS :=

LOCAL_HEADER_LIBRARIES += mm-camera-headers

ifeq ($(CAMX_EXT_VBUILD),)
  # set LOCAL_GENERATED_SOURCES for the non-VGDB build
  LOCAL_GENERATED_SOURCES := $(addprefix $(CAMX_GEN_DIR)/,$(CAMX_GEN_SRC_FILES))
  LOCAL_REQUIRED_MODULES  := camx_buildbins
else
  # set LOCAL_SRC/INC_FILES for the VGDB build
  LOCAL_INC_FILES := $(addprefix $(CAMX_GEN_DIR)/,$(CAMX_GEN_INC_FILES))
  LOCAL_SRC_FILES := $(addprefix $(CAMX_GEN_DIR)/,$(CAMX_GEN_SRC_FILES))
endif

include $(BUILD_STATIC_LIBRARY)

# Generate header library
ifeq ($(CAMX_EXT_VBUILD),)
include  $(CLEAR_VARS)
LOCAL_MODULE := libcamxgenerated_headers
LOCAL_MODULE_CLASS := HEADER_LIBRARIES
LOCAL_EXPORT_C_INCLUDE_DIRS :=                  \
    $(CAMX_GEN_DIR)/g_parser                    \
    $(CAMX_GEN_DIR)/g_facedetection             \
    $(CAMX_GEN_DIR)/g_sensor                    \
    $(CAMX_GEN_DIR)/g_chromatix
include $(BUILD_HEADER_LIBRARY)
endif # ($(CAMX_EXT_VBUILD),)

# The following section call the buildbins.py to build binaries for NDK only.

ifeq ($(CAMX_EXT_VBUILD),)
CAMX_BIN_OUTPUT_LOC   := ./$(TARGET_OUT_VENDOR)/lib/camera,./$(TARGET_OUT_VENDOR)/lib64/camera
else
CAMX_BIN_OUTPUT_LOC   := $(CAMX_CHICDK_PATH)/oem/qcom/bin
endif

ifeq ( ,$(filter msmnile_tb, $(TARGET_BOARD_PLATFORM)))
CAMX_BUILD_CODE_BIN   := $(CAMX_PYTHON) $(CAMX_BUILDBINS_SCRIPT) \
                         --bin-path=$(CAMX_BIN_OUTPUT_LOC) --target=bin \
                         --yaml-file-name=buildbins.yaml
else
CAMX_BUILD_CODE_BIN   := $(CAMX_PYTHON) $(CAMX_BUILDBINS_SCRIPT) \
                         --bin-path=$(CAMX_BIN_OUTPUT_LOC) --target=bin \
                         --yaml-file-name=buildbins_msmnile_tb.yaml
endif

# Call the buildbins.py while parsing the makefiles in VGDB environment.
CAMX_BUILD_OUTPUT     := $(shell $(CAMX_BUILD_CODE_BIN) && echo $(CAMX_SUCCESS_PHRASE))
# Show the output to the screen
CAMX_BUILD_OUTPUT_1   := $(subst $(CAMX_SUCCESS_PHRASE),,$(CAMX_BUILD_OUTPUT))
$(info $(CAMX_BUILD_OUTPUT_1))

# Something is wrong if the last word in the outputs is not the CAMX_SUCCESS_PHRASE.
ifneq ($(CAMX_SUCCESS_PHRASE),$(lastword $(CAMX_BUILD_OUTPUT)))
  $(error Cannot generate supplementary makefiles)
endif

# End of buildbins.py call

# set the LOCAL_* variables for the VS project
LOCAL_MODULE    := libcamxgenerated
LOCAL_INC_FILES := $(addprefix $(CAMX_GEN_DIR)/,$(CAMX_GEN_INC_FILES))
LOCAL_SRC_FILES := $(addprefix $(CAMX_GEN_DIR)/,$(CAMX_GEN_SRC_FILES))