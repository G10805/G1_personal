////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Copyright (c) 2020-2021 Qualcomm Technologies, Inc.
// All Rights Reserved.
// Confidential and Proprietary - Qualcomm Technologies, Inc.
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @file  ais_pproc_framesync.h
/// @brief AisPProcFrameSync class declarations
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#ifndef _AIS_PPROC_FRAMESYNC_H_
#define _AIS_PPROC_FRAMESYNC_H_

#include "ais_i.h"
#include "ais_engine.h"

#include <map>
#include <list>


// Enumeration of for the inflight buffers
// used in synchronization process
typedef enum
{
    FrameSyncBufLeft,
    FrameSyncBufRight,
    FrameSyncBufMax
} FrameSyncBufType;

//
// Forward declarations
//
class IFrameSyncSession;

//
// Definitions
//
typedef std::map<AisUsrCtxt*, IFrameSyncSession*> AisPProcFrameSyncSessionMap;
typedef std::map<int, unsigned int> AisPProcFrameSyncRetBufMap;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief Defines IFrameSyncSession class : interface of frame sync session
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class IFrameSyncSession
{
public:
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// IFrameSyncSession
    /// @brief  Destructor
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual ~IFrameSyncSession() {};

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// ProcessEvent
    /// @brief  Process PPROC Event
    /// @param  pEvent : PProc event pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual CameraResult ProcessEvent(AisEventMsgType* pEvent) = 0;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief Class that implements the IFE frame sync session
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class AisPprocFrameSyncSession : public IFrameSyncSession
{
public:
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// AisPprocFrameSyncSession
    /// @brief  Constructor
    /// @param  pUsrCtxt : AIS user context pointer
    /// @param  pProcChain : AIS proc chain pointer
    /// @return None
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    AisPprocFrameSyncSession(AisUsrCtxt* pUsrCtxt, const AisProcChainType* pProcChain);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// ~AisPprocFrameSyncSession
    /// @brief  Destructor
    /// @return None
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual ~AisPprocFrameSyncSession();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// ProcessEvent
    /// @brief  Process PPROC Event
    /// @param  pEvent : PProc event pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual CameraResult ProcessEvent(AisEventMsgType* pEvent);

private:
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Synchronize
    /// @brief  Runs sync check for in-flight buffers
    /// @return CAMERA_SUCCESS or error code in case of failure. CAMERA_ENEEDMORE is a special error code
    ///         indicating that sync procedure needs more buffers.
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    CameraResult Synchronize();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// ReturnBuffer
    /// @brief  Returns buffer to source
    /// @param  bufType : Buffer type (left or right)
    /// @param  idx : Buffer index
    /// @param  seqNum : Sequence number (represents frame number)
    /// @param  addToMap : Add to map flag specifying if add thid buffer to tracking map
    /// @return CAMERA_SUCCESS or error code in case of failure.
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    CameraResult ReturnBuffer(FrameSyncBufType bufType,
                                   int              idx,
                                   unsigned int     seqNum,
                                   boolean          addToMap);

    ///< Constants
    const uint64                    m_ErrorReportThreshold = 1;

    ///< user context
    AisUsrCtxt*                     m_pUsrCtxt;
    ///< In-flight buffer lists to store frame info for sync operation
    std::list<qcarcam_frame_info_v2_t> m_inFlightBufs[FrameSyncBufMax];
    ///< Map to track return buffers to prevent double return to IFE
    AisPProcFrameSyncRetBufMap      m_retBufs;
    ///< Mapping of bufferlist to buffer type
    uint32                          m_bufferlistIdx[FrameSyncBufMax];

    ///< Error report counters
    uint64                          m_ErrorReportCnt;

    ///< Stats counters
    uint64                          m_TotalSyncCnt;
    uint64                          m_SuccessSyncCnt;
    uint64                          m_FailSyncCnt;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief Class that implements the PProc frame sync class
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
class AisPprocFrameSync : public AisPProc
{
public:
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Create
    /// @brief  Static method to create AisPprocFrameSync object
    /// @return Pointer to the concrete AisPprocFrameSync object
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    static AisPprocFrameSync* Create();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Destroy
    /// @brief  This method destroys the instance of the AisPprocFrameSync
    /// @return None
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    static void Destroy();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// GetInstance
    /// @brief  This method the instance of AisPprocFrameSync
    /// @return None
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    static AisPprocFrameSync* GetInstance();


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// CreateSession
    /// @brief  Creates session for specific user context
    /// @param  pUsrCtxt : AIS user context pointer
    /// @param  pProcChain : AIS proc chain pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual CameraResult CreateSession(AisUsrCtxt* pUsrCtxt, const AisProcChainType* pProcChain);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// DestroySession
    /// @brief  Destroys session for specific user context
    /// @param  pUsrCtxt : AIS user context pointer
    /// @param  pProcChain : AIS proc chain pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual CameraResult DestroySession(AisUsrCtxt* pUsrCtxt, const AisProcChainType* pProcChain);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Flush
    /// @brief  Flush job for specific user context
    /// @param  pUsrCtxt : AIS user context pointer
    /// @param  pProcChain : AIS proc chain pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual CameraResult Flush(AisUsrCtxt* pUsrCtxt, const AisProcChainType* pProcChain)
    {
        CAM_UNUSED(pUsrCtxt);
        CAM_UNUSED(pProcChain);

        return CAMERA_SUCCESS;
    };

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// ProcessEvent
    /// @brief  Process Pproc event for specific user context
    /// @param  pUsrCtxt : AIS user context pointer
    /// @param  pEvent : PProc event pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual CameraResult ProcessEvent(AisUsrCtxt* pUsrCtxt, AisEventMsgType* pEvent);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// SetParams
    /// @brief  Applies params for specific user context
    /// @param  pUsrCtxt : AIS user context pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual CameraResult SetParams(AisUsrCtxt* pUsrCtxt);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// GetParams
    /// @brief  Retreives params for specific user context
    /// @param  pUsrCtxt : AIS user context pointer
    /// @param  pParamOut : parameter pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual CameraResult GetParams(AisUsrCtxt* pUsrCtxt, void *pParamOut);

private:
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// AisPprocFrameSync
    /// @brief     Constructor
    /// @return    None
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    AisPprocFrameSync();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// ~AisPprocFrameSync
    /// @brief  Destructor
    /// @return None
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    virtual ~AisPprocFrameSync();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// AddSession
    /// @brief  Adds session to the map
    /// @param  pUsrCtxt : AIS user context pointer
    /// @param  pSession : Session pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    CameraResult AddSession(AisUsrCtxt* pUsrCtxt, IFrameSyncSession* pSession);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// RemoveSession
    /// @brief  Deletes session to the map
    /// @param  pUsrCtxt : AIS user context pointer
    /// @return CAMERA_SUCCESS or error code in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    CameraResult RemoveSession(AisUsrCtxt* pUsrCtxt);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// GetSession
    /// @brief  Retrieves session from the map
    /// @param  pUsrCtxt : AIS user context pointer
    /// @return IFrameSyncSession pointer or NULL in case of failure
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    IFrameSyncSession* GetSession(AisUsrCtxt* pUsrCtxt);

    AisPProcFrameSyncSessionMap m_SessionMap;       ///< Map of sessions
    static AisPprocFrameSync*   m_pNodeInstance;    ///< Single instance of the node
};
#endif // _AIS_PPROC_FRAMESYNC_H_
